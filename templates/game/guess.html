{% extends "game/base.html" %}
{% load static %}

{% block title %}äºˆæƒ³å…¥åŠ› - Ante {{ ante_num }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">

        <div class="glass-card-guess text-center">
            <h2 class="text-light mb-4">ğŸ¯ Ante {{ ante_num }}ï¼šäºˆæƒ³å…¥åŠ›</h2>

            <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form method="post">
                {% csrf_token %}
                <div class="mb-3 text-start">
                    <label for="guessInput" class="form-label text-white fw-bold">ğŸ”¢ äºˆæƒ³æ•°å­—ï¼ˆãƒ‡ãƒƒã‚­ã‹ã‚‰ã‚¯ãƒªãƒƒã‚¯ï¼‰</label>
                    <input type="text" id="guessInput" name="guess" class="form-control bg-transparent text-white border-light" readonly maxlength="4">
                    <input type="hidden" name="indexes" id="guessIndexes">
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-outline-warning me-2" onclick="removeLast()">1æ–‡å­—å‰Šé™¤</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearInput()">ã‚¯ãƒªã‚¢</button>
                </div>

                <button type="submit" class="btn btn-outline-light px-4">ğŸ¯ äºˆæƒ³ã™ã‚‹</button>
            </form>
        </div>

        <!-- ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ -->
        {% with item_cards=consume_cards %}
        {% if item_cards %}
        <div class="glass-card">
            <h5 class="text-white mb-3">ğŸ§ª ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰</h5>
            <ul class="list-group list-group-flush">
                {% for card in item_cards %}
                    {% if card.kind == 'item' %}
                    <li class="list-group-item bg-transparent text-white d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ card.name }}</strong><br>
                            <small class="text-muted">{{ card.description }}</small>
                        </div>
                        <form method="post" action="{% url 'use_item_card' %}">
                            {% csrf_token %}
                            <input type="hidden" name="code" value="{{ card.code }}">
                            <button type="submit" class="btn btn-sm btn-outline-success">ä½¿ç”¨</button>
                        </form>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}

        <!-- äºˆæƒ³å±¥æ­´ -->
        <div class="glass-card-history">
            <h5 class="text-white mb-3">ğŸ“œ ã“ã‚Œã¾ã§ã®äºˆæƒ³</h5>
            {% if results %}
                <ul class="list-group list-group-flush">
                    {% for r in results %}
                        <li class="list-group-item bg-transparent text-white">
                            <strong>{{ r.guess }}</strong> â†’ {{ r.hit }}H {{ r.blow }}B<br>
                            <small>ãƒ»å½¹ç‚¹ï¼š{{ r.yaku_score }} / ã‚«ãƒ¼ãƒ‰ç‚¹ï¼š{{ r.card_score }} / åˆè¨ˆï¼š{{ r.total_score }}</small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">ã¾ã äºˆæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>

    </div>
    <!-- ğŸ”¢ é¸æŠç”¨ãƒ‡ãƒƒã‚­ä¸€è¦§ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ -->
    <div class="glass-card-deck">
        <h5 class="text-white text-center mb-4">ğŸ”¢ ãƒ‡ãƒƒã‚­ã‹ã‚‰æ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„</h5>
        <div class="row">
            {% for card in deck_numbers %}
                <div class="col-6 col-sm-4 col-md-2 mb-4">
                    <div class="p-3 border rounded text-center text-white deck-click"
                        style="background-color: rgba(255,255,255,0.05); cursor: pointer;"
                        data-number="{{ card.number }}"
                        data-index="{{ forloop.counter0 }}">
                        <div class="fw-bold fs-3"
                            style="color: #fff; text-shadow: 0 0 5px #000;">
                            {{ card.number }}
                        </div>
                        <div style="color: #fff; font-size: 0.9rem; text-shadow: 0 0 4px rgba(0,0,0,0.8);">
                            åŠ¹æœ: {{ card.effect|default:"ãªã—" }}<br>
                            ğŸŸ¥ Red Seal: {{ card.red_seal|yesno:"ã‚ã‚Š,ãªã—" }}<br>
                            ğŸŸ¨ Gold Seal: {{ card.gold_seal|yesno:"ã‚ã‚Š,ãªã—" }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    
</div>

<!-- JSã§å…¥åŠ›å‡¦ç† -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const input = document.getElementById("guessInput");
        const indexInput = document.getElementById("guessIndexes");
        const deckElements = document.querySelectorAll(".deck-click");

        deckElements.forEach(elem => {
            elem.addEventListener("click", () => {
                const number = elem.dataset.number;
                const index = elem.dataset.index;

                if (input && input.value.length < 4 && !input.value.includes(number)) {
                    input.value += number;
                    indexInput.value += index;
                }
            });
        });

        window.removeLast = function () {
            if (input.value.length > 0) input.value = input.value.slice(0, -1);
            if (indexInput.value.length > 0) indexInput.value = indexInput.value.slice(0, -1);
        };

        window.clearInput = function () {
            input.value = "";
            indexInput.value = "";
        };
    });
</script>
{% endblock %}

{% extends "game/base.html" %}
{% load static %}

{% block title %}äºˆæƒ³å…¥åŠ› - Ante {{ ante_num }}{% endblock %}

{% block content %}
<!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
<div id="timer-box" style="
position: fixed;
top: 20px;
right: 30px;
background-color: rgba(255, 255, 255, 0.85);
padding: 10px 20px;
border-radius: 8px;
font-weight: bold;
font-size: 1.2rem;
z-index: 9999;
font-family: 'Cinzel', serif;
">
æ®‹ã‚Šæ™‚é–“ï¼š<span id="timer">60</span>ç§’
</div>
<form id="timeout-form" method="post" action="{% url 'timeout_force_end' ante_num=ante_num %}">
    {% csrf_token %}
</form>

<div class="row justify-content-center" style="position: relative; min-height: 60vh;">
    <div class="col-md-10 col-lg-8">

        <form method="post">
            {% csrf_token %}
        
            <div class="glass-card-guess text-center">
                <h2 class="text-dark mb-3" style="font-size: 3.5vh; font-family: 'Cinzel', serif !important;">Ante {{ ante_num }}ï¼šäºˆæƒ³</h2>
            
                <!-- è¡¨ç¤ºæ¬„ -->
                <div id="guessDisplay" class="guess-display-box mb-3" style="font-family: 'Cinzel', serif !important;">
                    ã‚¯ãƒªãƒƒã‚¯å…¥åŠ›
                </div>
            
                <!-- ãƒœã‚¿ãƒ³3ã¤ -->
                <div class="d-flex flex-wrap justify-content-center gap-2 mb-3" style="font-family: 'Cinzel', serif !important;">
                    <button type="button" class="btn custom-btn" onclick="removeLast()">1æ–‡å­—å‰Šé™¤</button>
                    <button type="button" class="btn custom-btn" onclick="clearInput()">ã‚¯ãƒªã‚¢</button>
                    <button type="submit" class="btn custom-btn">äºˆæƒ³ã™ã‚‹</button>
                </div>
            
                <!-- hidden -->
                <input type="hidden" name="guess" id="guessInput">
                <input type="hidden" name="indexes" id="guessIndexes">
            </div>
        </form>

        <!-- ğŸ”¢ é¸æŠç”¨ãƒ‡ãƒƒã‚­ä¸€è¦§ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ï¼‰ -->
        <div class="glass-card-deck">
            <h5 class="text-black text-center mb-4" style="font-family: 'Cinzel', serif !important;">ãƒ‡ãƒƒã‚­ã‹ã‚‰æ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„</h5>
            <div class="row">
                {% for card in deck_numbers %}
                    <div class="deck-card-box mb-3">
                        <div class="p-3 border rounded text-center text-black deck-click"
                            data-number="{{ card.number }}"
                            data-index="{{ forloop.counter0 }}">
                            <div class="fw-bold fs-3"
                                style="color: #111; text-shadow: 0 0 2px #000;">
                                {{ card.number }}
                            </div>
                            <div style="color: #111; font-size: 0.7rem; text-shadow: 0 0 1px rgba(0,0,0,0.8); font-family: 'Cinzel', serif !important;">
                                åŠ¹æœ: {{ card.effect|default:"ãªã—" }}<br>
                                ğŸŸ¥ ï¼š{{ card.red_seal|yesno:"ã‚ã‚Š,ãªã—" }}<br>
                                ğŸŸ¨ ï¼š{{ card.gold_seal|yesno:"ã‚ã‚Š,ãªã—" }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ -->
        {% with item_cards=consume_cards %}
        {% if item_cards %}
        <div class="glass-card" style="max-width: 45vw; width: 90%; margin: 5vh auto; font-family: 'Cinzel', serif !important; background-color: white;">
            <h5 class="text-black mb-3">ä½¿ç”¨å¯èƒ½ãªã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰</h5>
            <ul class="list-group list-group-flush">
                {% for card in item_cards %}
                    {% if card.kind == 'item' %}
                    <li class="list-group-item bg-transparent text-black d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ card.name }}</strong><br>
                            <small class="text-muted">{{ card.description }}</small>
                        </div>
                        <form method="post" action="{% url 'use_item_card' %}">
                            {% csrf_token %}
                            <input type="hidden" name="code" value="{{ card.code }}">
                            <button type="submit" class="btn btn-sm btn-outline-success">ä½¿ç”¨</button>
                        </form>
                    </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}

        <!-- äºˆæƒ³å±¥æ­´ -->
        <div class="glass-card-history">
            <h5 class="text-black mb-3" style="font-family: 'Cinzel', serif !important;">ã“ã‚Œã¾ã§ã®äºˆæƒ³</h5>
            {% if results %}
                <ul class="list-group list-group-flush">
                    {% for r in results %}
                        <li class="list-group-item bg-transparent text-black" style="font-family: 'Cinzel', serif !important;">
                            <strong>{{ r.guess }}</strong> â†’ {{ r.hit }}H {{ r.blow }}B<br>
                            <small>
                                ãƒ»å½¹ç‚¹ï¼š{{ r.yaku_score }} / ã‚«ãƒ¼ãƒ‰ç‚¹ï¼š{{ r.card_score }}<br>
                                ãƒ»åˆè¨ˆï¼š{{ r.total_score }}
                            </small>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted" style="font-family: 'Cinzel', serif !important;">ã¾ã äºˆæƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- JSã§å…¥åŠ›å‡¦ç† -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const guessDisplay = document.getElementById("guessDisplay");
        const guessInput = document.getElementById("guessInput");
        const indexInput = document.getElementById("guessIndexes");
        const deckElements = document.querySelectorAll(".deck-click");

        deckElements.forEach(elem => {
            elem.addEventListener("click", () => {
                const number = elem.dataset.number;
                const index = elem.dataset.index;

                if (guessInput.value.length < 4 && !guessInput.value.includes(number)) {
                    guessInput.value += number;
                    indexInput.value += index;
                    guessDisplay.textContent = guessInput.value;
                }
            });
        });

        window.removeLast = function () {
            if (guessInput.value.length > 0) {
                guessInput.value = guessInput.value.slice(0, -1);
                indexInput.value = indexInput.value.slice(0, -1);
                guessDisplay.textContent = guessInput.value || "ã‚¯ãƒªãƒƒã‚¯å…¥åŠ›";
            }
        };

        window.clearInput = function () {
            guessInput.value = "";
            indexInput.value = "";
            guessDisplay.textContent = "ã‚¯ãƒªãƒƒã‚¯å…¥åŠ›";
        };
    });
</script>

<script>
    let timeLeft = 60;
    const timerElement = document.getElementById("timer");

    const countdown = setInterval(() => {
        timeLeft--;
        timerElement.textContent = timeLeft;

        if (timeLeft <= 0) {
            clearInterval(countdown);
            document.getElementById("timeout-form").submit();
        }
    }, 1000);
</script>
{% endblock %}
